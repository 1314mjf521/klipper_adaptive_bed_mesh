import unittest
from unittest import mock
from adaptive_bed_mesh import AdaptiveBedMesh
import os
import glob

dir_path = os.path.dirname(os.path.realpath(__file__))
test_data_dir = os.path.join(dir_path, 'test_data')


class TestAdaptiveBedMesh(unittest.TestCase):
    def setUp(self) -> None:
        self.mocked_config = mock.MagicMock()
        self.mocked_config.getsection.side_effect = self.mocked_get_section
        self.mocked_config.getfloat.side_effect = self.mocked_get_float
        self.mocked_config.getint.side_effect = self.mocked_get_float

        self.adaptive_bed_mesh = AdaptiveBedMesh(self.mocked_config)

    def mocked_getfloatlist(self, name, count):
        if name == 'mesh_min':
            return 0, 0
        elif name == 'mesh_max':
            return 350, 350

    def mocked_get_section(self, name):
        if name == 'bed_mesh':
            mocked_bed_mesh_config = mock.MagicMock()
            mocked_bed_mesh_config.getfloatlist.side_effect = self.mocked_getfloatlist
            return mocked_bed_mesh_config

    def mocked_get_float(self, name, default):
        return default

    def test_generate_bed_mesh_with_exclude_object(self):
        objects = [[[43.5393,31.1042],[43.5408,31.0533],[43.5422,31.025],[43.5443,30.9946],[43.5492,30.9359],[43.5563,30.8779],[43.5591,30.8553],[43.5641,30.8207],[43.5648,30.8157],[43.5747,30.7577],[43.5797,30.7316],[43.5846,30.7054],[43.5987,30.6432],[43.6136,30.5859],[43.6299,30.53],[43.6426,30.489],[43.6511,30.4636],[43.6687,30.4134],[43.6914,30.354],[43.7126,30.3031],[43.7359,30.25],[43.7621,30.197],[43.7635,30.1942],[43.7882,30.1454],[43.8165,30.0945],[43.8462,30.0436],[43.8795,29.9905],[43.912,29.9424],[43.9431,29.8986],[43.9466,29.8937],[43.9778,29.8512],[44.0046,29.8173],[44.0223,29.7954],[44.0746,29.7345],[44.0994,29.707],[44.1192,29.6858],[57.1038,16.7012],[57.149,16.6601],[57.1915,16.6234],[57.2325,16.5894],[57.2452,16.5795],[57.2827,16.5505],[57.3301,16.5159],[57.405,16.465],[57.4545,16.4339],[57.5054,16.4042],[57.5287,16.3907],[57.5811,16.3625],[57.661,16.3236],[57.697,16.3073],[57.7508,16.2847],[57.7677,16.2776],[57.8052,16.2628],[57.859,16.243],[57.9035,16.2281],[57.9707,16.2076],[58.0004,16.1991],[58.0237,16.1927],[58.1142,16.1715],[58.1461,16.1652],[58.1708,16.1602],[58.2288,16.1503],[58.2868,16.1418],[58.3546,16.1348],[58.3935,16.1312],[58.4395,16.1277],[58.4982,16.1256],[58.5187,16.1249],[58.53,16.1249],[58.588,16.1249],[58.6156,16.1256],[58.6743,16.1277],[58.7181,16.1305],[58.7761,16.1362],[58.7902,16.1376],[58.8348,16.1425],[58.9062,16.1532],[58.9635,16.1638],[59.0151,16.1744],[59.09,16.1927],[59.1204,16.2005],[59.177,16.2175],[59.2039,16.226],[59.2329,16.2352],[59.2562,16.243],[59.3142,16.2642],[59.3729,16.2875],[59.4224,16.3087],[59.4754,16.3335],[59.4867,16.3391],[59.527,16.3596],[59.5391,16.366],[59.5907,16.3936],[59.597,16.3971],[59.6303,16.4162],[59.6656,16.4374],[59.6798,16.4459],[59.7399,16.4848],[59.7639,16.5018],[59.788,16.5187],[59.812,16.5357],[82.3779,33.589],[82.5731,33.7375],[82.7682,33.8874],[82.962,34.0387],[83.2292,34.2508],[83.4039,34.3916],[83.5955,34.5464],[83.7865,34.7034],[83.976,34.8618],[84.164,35.0202],[84.2906,35.1284],[84.3514,35.1807],[84.4957,35.3051],[84.5381,35.3419],[84.7248,35.5045],[84.8457,35.6113],[84.9086,35.6672],[85.0288,35.7747],[85.2198,35.9472],[85.2997,36.02],[85.3159,36.0349],[85.4163,36.1268],[85.5273,36.2293],[85.6327,36.3276],[85.7183,36.4075],[85.7663,36.4528],[85.8455,36.5277],[85.9311,36.609],[85.9947,36.6699],[86.0966,36.7674],[86.2345,36.9011],[86.3639,37.0277],[86.448,37.1104],[86.5442,37.2065],[86.7294,37.3918],[86.9797,37.645],[87.2817,37.9582],[87.3368,38.0162],[87.5815,38.275],[87.6543,38.3535],[87.8771,38.5946],[88.1705,38.9177],[88.3918,39.1674],[88.447,39.2296],[88.5198,39.3123],[88.6337,39.4431],[88.7122,39.5343],[88.8076,39.6454],[88.8642,39.7118],[88.9816,39.8504],[89.0657,39.9501],[89.5381,40.5992],[89.543,40.607],[89.7707,40.9846],[89.828,41.0801],[89.9432,41.2731],[90.0175,41.3997],[90.0571,41.4676],[90.137,41.6055],[90.2812,41.8586],[90.3703,42.0184],[90.4983,42.2525],[90.6058,42.4505],[90.7104,42.6484],[90.8179,42.8549],[90.9261,43.0663],[91.018,43.2488],[91.1375,43.4913],[91.216,43.6532],[91.2408,43.7049],[91.3171,43.8661],[91.4076,44.0598],[91.5059,44.2741],[91.5986,44.4798],[91.6848,44.6764],[91.7322,44.7846],[91.7746,44.8836],[91.7789,44.8935],[91.8673,45.1007],[91.9542,45.3093],[91.9769,45.3644],[92.0617,45.5737],[92.1445,45.7838],[92.2265,45.9931],[92.3849,46.4145],[92.4612,46.6252],[92.5369,46.8366],[92.6104,47.0488],[92.6826,47.2609],[92.754,47.4737],[92.8226,47.6866],[92.8905,47.9001],[92.9562,48.1144],[93.0213,48.3293],[93.0842,48.5436],[93.1457,48.7593],[93.2051,48.9756],[93.2645,49.192],[93.3218,49.4091],[93.3769,49.6269],[93.4307,49.8447],[93.483,50.0639],[93.5346,50.2824],[93.5841,50.503],[93.6322,50.7222],[93.6782,50.9435],[93.7234,51.1641],[93.7673,51.3862],[93.8097,51.6082],[93.85,51.8309],[93.8889,52.0537],[93.9264,52.2764],[93.9624,52.5006],[93.9971,52.7247],[94.0303,52.9503],[94.0614,53.1751],[94.0918,53.4007],[94.1201,53.627],[94.147,53.8533],[94.1724,54.0809],[94.1965,54.3086],[94.2191,54.5363],[94.2396,54.7647],[94.2764,55.2229],[94.2926,55.4527],[94.3068,55.6832],[94.3195,55.9138],[94.3308,56.1457],[94.3372,56.3006],[94.3464,56.5304],[94.3535,56.7609],[94.3584,56.9907],[94.3619,57.2205],[94.3648,57.451],[94.3655,57.6808],[94.3641,57.9113],[94.3619,58.1411],[94.3577,58.3717],[94.352,58.6022],[94.345,58.8327],[94.3365,59.0632],[94.3259,59.2944],[94.3146,59.525],[94.3004,59.7555],[94.2856,59.9867],[94.27,60.2172],[94.2509,60.4484],[94.2311,60.679],[94.2106,60.9102],[94.188,61.1407],[94.1632,61.3719],[94.1371,61.6031],[94.1095,61.8344],[94.0805,62.0656],[94.0494,62.2961],[94.0176,62.5273],[93.9843,62.7586],[93.949,62.9891],[93.9115,63.2203],[93.8726,63.4515],[93.833,63.682],[93.7913,63.9133],[93.7482,64.1445],[93.7029,64.375],[93.6916,64.4273],[93.6775,64.4881],[93.6619,64.5475],[93.6449,64.6069],[93.6265,64.6663],[93.6067,64.7243],[93.5615,64.8403],[93.5438,64.8806],[93.5184,64.9372],[93.4915,64.9923],[93.4632,65.0475],[93.4335,65.1012],[93.401,65.1564],[93.3706,65.2066],[93.3366,65.2575],[93.3006,65.3105],[93.2652,65.3586],[93.2277,65.4074],[93.1896,65.4555],[93.1493,65.5028],[93.1026,65.5538],[93.0609,65.5983],[93.0177,65.6414],[92.9739,65.6839],[92.9286,65.7249],[92.8827,65.7638],[92.8353,65.8027],[92.7865,65.8401],[92.7377,65.8762],[92.6896,65.9101],[92.6359,65.9455],[92.5864,65.9766],[92.5305,66.0098],[92.4817,66.0374],[92.4273,66.0664],[92.3721,66.0933],[92.3163,66.1194],[92.2604,66.1442],[92.2039,66.1668],[92.1466,66.1887],[92.0879,66.2092],[92.0299,66.2276],[91.9705,66.2446],[91.9104,66.2609],[91.8503,66.2757],[91.7895,66.2884],[91.5837,66.3287],[91.3525,66.3719],[91.1213,66.4136],[90.8908,66.4546],[90.6595,66.4935],[90.4276,66.5303],[90.1964,66.5663],[89.9651,66.601],[89.7339,66.6328],[89.502,66.6639],[89.2708,66.6929],[89.0388,66.7212],[88.575,66.7721],[88.343,66.7947],[88.1104,66.8166],[87.8778,66.8357],[87.6458,66.8541],[87.4125,66.8711],[87.1799,66.8859],[86.9472,66.8994],[86.7754,66.9086],[86.5428,66.9192],[86.3101,66.9284],[86.0775,66.9361],[85.8455,66.9418],[85.6129,66.9468],[85.381,66.9496],[84.9185,66.951],[84.4575,66.9453],[84.2277,66.9404],[83.9972,66.9333],[83.7681,66.9248],[83.539,66.9149],[83.3099,66.9036],[83.0808,66.8909],[82.8517,66.8767],[82.6233,66.8605],[82.3949,66.8428],[82.1665,66.8237],[81.9388,66.8025],[81.7111,66.7799],[81.4834,66.7558],[81.2564,66.7311],[81.0287,66.7042],[80.8018,66.6752],[80.5748,66.6448],[80.3478,66.613],[80.1208,66.5798],[79.8945,66.5444],[79.6676,66.5083],[79.2164,66.4306],[78.9909,66.3888],[78.7653,66.3457],[78.5404,66.3019],[78.3156,66.2552],[78.0914,66.2078],[77.8666,66.1583],[77.6431,66.1074],[77.4197,66.0551],[77.1955,66.0006],[76.9728,65.9448],[76.75,65.8875],[76.528,65.8281],[76.3053,65.768],[76.0846,65.7058],[75.8626,65.6421],[75.5621,65.5523],[75.3471,65.4859],[75.1329,65.4187],[74.9193,65.3494],[74.7058,65.2787],[74.4937,65.2066],[74.2815,65.133],[74.0708,65.0581],[73.8601,64.9817],[73.6501,64.9032],[73.4408,64.824],[73.2315,64.7434],[73.0236,64.6614],[72.8164,64.5772],[72.6092,64.4917],[72.5194,64.4542],[72.4027,64.4054],[72.197,64.317],[71.982,64.2223],[71.8653,64.1706],[71.574,64.0391],[71.3704,63.9444],[71.178,63.8539],[70.9659,63.752],[70.7884,63.6651],[70.7743,63.658],[70.5735,63.5576],[70.3733,63.4565],[70.152,63.3426],[69.966,63.2443],[69.942,63.2316],[69.732,63.1192],[69.5234,63.0053],[69.3162,62.8901],[69.1776,62.8123],[69.1083,62.7727],[68.9818,62.6999],[68.7866,62.5867],[68.6975,62.5344],[68.5928,62.4722],[68.3991,62.3562],[68.0229,62.1299],[67.5789,61.8287],[67.5711,61.8223],[67.3731,61.6583],[67.337,61.6279],[67.1892,61.5027],[67.1242,61.4476],[66.999,61.3408],[66.9382,61.2885],[66.6759,61.0601],[66.3414,60.7638],[66.3124,60.7376],[66.0268,60.4788],[65.9249,60.3855],[65.6697,60.1486],[65.5141,60.0015],[65.3536,59.8495],[65.0403,59.5462],[64.766,59.2746],[64.5227,59.0314],[64.3127,58.8171],[64.2738,58.7768],[64.1197,58.617],[64.0207,58.5138],[63.9394,58.4282],[63.8213,58.3031],[63.7598,58.2373],[63.6601,58.1305],[63.5392,57.9997],[63.5229,57.9821],[63.4161,57.8654],[63.3433,57.7855],[63.2563,57.6886],[63.1234,57.5401],[62.9607,57.3577],[62.7988,57.1731],[62.7889,57.1618],[62.6008,56.944],[62.4403,56.7566],[62.2805,56.5671],[62.1638,56.4264],[62.1228,56.3769],[62.0076,56.2376],[61.8527,56.0474],[61.8096,55.9944],[61.6986,55.8565],[61.5006,55.6076],[61.3478,55.4124],[61.2439,55.2774],[61.0459,55.02],[43.9686,32.4216],[43.9473,32.3933],[43.9176,32.3523],[43.8851,32.3042],[43.8674,32.2766],[43.837,32.2264],[43.8307,32.2158],[43.8116,32.1826],[43.8059,32.1727],[43.7783,32.121],[43.7536,32.0722],[43.7479,32.0609],[43.7232,32.0079],[43.702,31.9584],[43.6786,31.8997],[43.6574,31.8417],[43.6426,31.7972],[43.6256,31.742],[43.62,31.7222],[43.6072,31.6756],[43.5924,31.6169],[43.5888,31.6006],[43.5804,31.5596],[43.5782,31.549],[43.5676,31.4917],[43.5606,31.4436],[43.5591,31.4337],[43.5521,31.3757],[43.5471,31.327],[43.5464,31.3178],[43.5422,31.2598],[43.5401,31.2011],[43.5393,31.1721],[43.5393,31.1042]],
                   [[23.3962,72.3742],[23.3992,72.3132],[23.4032,72.2572],[23.4082,72.2042],[23.4102,72.1882],[23.4162,72.1412],[23.4252,72.0832],[23.4422,71.9942],[23.4552,71.9372],[23.4702,71.8802],[23.4772,71.8542],[23.4942,71.7972],[23.5232,71.7132],[23.5372,71.6762],[23.5592,71.6222],[23.5662,71.6052],[23.5822,71.5682],[23.6062,71.5162],[23.6272,71.4742],[23.6602,71.4122],[23.6752,71.3852],[23.6872,71.3642],[23.7362,71.2852],[23.7542,71.2582],[23.7682,71.2372],[23.8022,71.1892],[23.8372,71.1422],[23.8802,71.0892],[23.9052,71.0592],[23.9352,71.0242],[23.9752,70.9812],[23.9892,70.9662],[23.9972,70.9582],[24.0382,70.9172],[24.0582,70.8982],[24.1012,70.8582],[24.1342,70.8292],[24.1792,70.7922],[24.1902,70.7832],[24.2252,70.7552],[24.2832,70.7122],[24.3312,70.6792],[24.3752,70.6502],[24.4412,70.6102],[24.4682,70.5942],[24.5202,70.5662],[24.5452,70.5532],[24.5722,70.5392],[24.5942,70.5282],[24.6502,70.5022],[24.7082,70.4772],[24.7582,70.4572],[24.8132,70.4372],[24.8252,70.4332],[24.8682,70.4192],[24.8812,70.4152],[24.9372,70.3982],[24.9442,70.3962],[24.9812,70.3862],[24.9932,70.3832],[25.0212,70.3762],[25.0372,70.3722],[25.1072,70.3572],[25.1362,70.3522],[25.1652,70.3472],[25.1942,70.3422],[53.2092,66.4442],[53.4522,66.4112],[53.6962,66.3792],[53.9402,66.3492],[54.2792,66.3102],[54.5022,66.2862],[54.7472,66.2602],[54.9932,66.2362],[55.2392,66.2142],[55.4842,66.1932],[55.6502,66.1802],[55.7302,66.1742],[55.9202,66.1602],[55.9762,66.1562],[56.2232,66.1392],[56.3842,66.1292],[56.4682,66.1242],[56.6292,66.1152],[56.8862,66.1022],[56.9942,66.0972],[57.0162,66.0962],[57.1522,66.0902],[57.3032,66.0842],[57.4472,66.0792],[57.5642,66.0752],[57.6302,66.0732],[57.7392,66.0702],[57.8572,66.0672],[57.9452,66.0652],[58.0862,66.0622],[58.2782,66.0592],[58.4592,66.0572],[58.5772,66.0562],[58.9752,66.0562],[59.3312,66.0582],[59.7662,66.0662],[59.8462,66.0682],[60.2022,66.0782],[60.3092,66.0822],[60.6372,66.0952],[61.0732,66.1162],[61.4062,66.1362],[61.4892,66.1412],[61.5992,66.1482],[61.7722,66.1602],[61.8922,66.1692],[62.0382,66.1802],[62.1252,66.1872],[62.3062,66.2022],[62.4362,66.2132],[63.2292,66.3382],[63.2382,66.3402],[63.6662,66.4462],[63.7742,66.4732],[63.9922,66.5282],[64.1342,66.5652],[64.2102,66.5852],[64.3642,66.6262],[64.6452,66.7032],[64.8212,66.7532],[65.0772,66.8282],[65.2932,66.8922],[65.5072,66.9582],[65.7292,67.0282],[65.9552,67.1012],[66.1492,67.1652],[66.4052,67.2522],[66.5752,67.3112],[66.6292,67.3302],[66.7972,67.3902],[66.9982,67.4632],[67.2192,67.5452],[67.4302,67.6252],[67.6302,67.7032],[67.7402,67.7462],[67.8402,67.7862],[67.8502,67.7902],[68.0592,67.8742],[68.2682,67.9602],[68.3232,67.9832],[68.5312,68.0712],[68.7382,68.1612],[68.9442,68.2512],[69.3542,68.4372],[69.5572,68.5322],[69.7602,68.6282],[69.9622,68.7262],[70.1632,68.8252],[70.3642,68.9252],[70.5632,69.0272],[70.7622,69.1302],[70.9602,69.2352],[71.1582,69.3412],[71.3542,69.4482],[71.5502,69.5572],[71.7452,69.6682],[71.9402,69.7792],[72.1342,69.8922],[72.3272,70.0072],[72.5192,70.1232],[72.7112,70.2412],[72.9022,70.3592],[73.0932,70.4802],[73.2822,70.6012],[73.4712,70.7252],[73.6592,70.8492],[73.8472,70.9752],[74.0342,71.1022],[74.2202,71.2312],[74.4052,71.3612],[74.5892,71.4922],[74.7732,71.6252],[74.9562,71.7592],[75.1392,71.8952],[75.3202,72.0322],[75.5012,72.1702],[75.6812,72.3102],[75.8602,72.4512],[76.0392,72.5942],[76.2172,72.7382],[76.3942,72.8832],[76.5702,73.0302],[76.9202,73.3282],[77.0942,73.4792],[77.2672,73.6322],[77.4392,73.7862],[77.6112,73.9422],[77.7252,74.0472],[77.8942,74.2032],[78.0622,74.3612],[78.2282,74.5202],[78.3932,74.6802],[78.5582,74.8412],[78.7212,75.0032],[78.8832,75.1672],[79.0442,75.3312],[79.2042,75.4972],[79.3632,75.6642],[79.5212,75.8322],[79.6782,76.0012],[79.8342,76.1722],[79.9892,76.3432],[80.1422,76.5162],[80.2952,76.6902],[80.4472,76.8642],[80.5972,77.0412],[80.7462,77.2182],[80.8952,77.3962],[81.0422,77.5752],[81.1882,77.7562],[81.3332,77.9382],[81.4772,78.1212],[81.6202,78.3052],[81.7612,78.4902],[81.9022,78.6762],[82.0422,78.8632],[82.1802,79.0512],[82.3172,79.2412],[82.4532,79.4322],[82.5882,79.6232],[82.7222,79.8162],[82.8552,80.0102],[82.9862,80.2052],[83.0152,80.2502],[83.0482,80.3032],[83.0792,80.3562],[83.1092,80.4102],[83.1382,80.4652],[83.1652,80.5202],[83.2152,80.6342],[83.2312,80.6752],[83.2532,80.7332],[83.2732,80.7912],[83.2922,80.8502],[83.3092,80.9092],[83.3252,80.9712],[83.3392,81.0282],[83.3512,81.0882],[83.3632,81.1512],[83.3722,81.2102],[83.3802,81.2712],[83.3872,81.3322],[83.3922,81.3942],[83.3952,81.4632],[83.3972,81.5242],[83.3972,81.5852],[83.3962,81.6462],[83.3932,81.7072],[83.3882,81.7672],[83.3822,81.8282],[83.3742,81.8892],[83.3652,81.9492],[83.3552,82.0072],[83.3422,82.0702],[83.3292,82.1272],[83.3132,82.1902],[83.2982,82.2442],[83.2802,82.3032],[83.2602,82.3612],[83.2392,82.4192],[83.2172,82.4762],[83.1932,82.5322],[83.1682,82.5882],[83.1412,82.6442],[83.1132,82.6982],[83.0832,82.7522],[83.0522,82.8062],[83.0202,82.8592],[82.9862,82.9112],[82.8692,83.0852],[82.7362,83.2792],[82.6022,83.4722],[82.4682,83.6642],[82.3322,83.8552],[82.1942,84.0452],[82.0562,84.2342],[81.9172,84.4222],[81.7762,84.6082],[81.6342,84.7942],[81.4912,84.9782],[81.3472,85.1622],[81.0552,85.5262],[80.9072,85.7062],[80.7582,85.8862],[80.6072,86.0642],[80.4562,86.2412],[80.3032,86.4182],[80.1492,86.5932],[79.9942,86.7672],[79.8792,86.8952],[79.7222,87.0672],[79.5642,87.2382],[79.4052,87.4082],[79.2452,87.5762],[79.0842,87.7442],[78.9222,87.9102],[78.5962,88.2382],[78.4312,88.3992],[78.2662,88.5602],[78.1002,88.7192],[77.9322,88.8772],[77.7642,89.0332],[77.5952,89.1882],[77.4252,89.3422],[77.2542,89.4952],[77.0822,89.6472],[76.9092,89.7972],[76.7352,89.9462],[76.5602,90.0942],[76.3842,90.2402],[76.2072,90.3852],[76.0292,90.5292],[75.8512,90.6722],[75.6712,90.8142],[75.4902,90.9542],[75.3082,91.0932],[75.1252,91.2312],[74.9412,91.3682],[74.7562,91.5032],[74.5702,91.6382],[74.1962,91.9022],[74.0072,92.0322],[73.8172,92.1612],[73.6272,92.2892],[73.4352,92.4152],[73.2432,92.5402],[73.0492,92.6642],[72.8552,92.7862],[72.6602,92.9072],[72.4632,93.0272],[72.2662,93.1452],[72.0682,93.2622],[71.8692,93.3772],[71.6692,93.4922],[71.4692,93.6042],[71.2672,93.7162],[70.9912,93.8652],[70.7922,93.9702],[70.5932,94.0742],[70.3932,94.1762],[70.1922,94.2772],[69.9912,94.3762],[69.7892,94.4742],[69.5872,94.5702],[69.3842,94.6652],[69.1802,94.7582],[68.9762,94.8502],[68.7712,94.9412],[68.5662,95.0302],[68.3602,95.1172],[68.1532,95.2032],[68.0632,95.2402],[67.9462,95.2882],[67.7382,95.3712],[67.5192,95.4562],[67.4002,95.5022],[67.1012,95.6152],[66.8902,95.6922],[66.6902,95.7642],[66.4682,95.8422],[66.2812,95.9062],[66.2662,95.9112],[66.0532,95.9822],[65.8402,96.0522],[65.6032,96.1282],[65.4022,96.1902],[65.3762,96.1982],[65.1482,96.2672],[64.9202,96.3342],[64.6922,96.3992],[64.5392,96.4422],[64.4622,96.4632],[64.3212,96.5012],[64.1032,96.5592],[64.0032,96.5852],[63.8852,96.6152],[63.6662,96.6702],[63.2402,96.7762],[62.7132,96.8772],[62.7032,96.8782],[62.4472,96.9022],[62.4002,96.9062],[62.2072,96.9222],[62.1222,96.9292],[61.9582,96.9422],[61.8782,96.9482],[61.5312,96.9722],[61.0852,96.9992],[61.0462,97.0012],[60.6612,97.0202],[60.5232,97.0262],[60.1752,97.0392],[59.9612,97.0452],[59.7402,97.0512],[59.3042,97.0582],[58.9182,97.0602],[58.5742,97.0602],[58.2742,97.0572],[58.2182,97.0562],[57.9962,97.0522],[57.8532,97.0492],[57.7352,97.0462],[57.5632,97.0412],[57.4732,97.0382],[57.3272,97.0332],[57.1492,97.0262],[57.1252,97.0252],[56.9672,97.0182],[56.8592,97.0132],[56.7292,97.0062],[56.5302,96.9952],[56.2862,96.9812],[56.0412,96.9652],[56.0262,96.9642],[55.7392,96.9432],[55.4932,96.9242],[55.2462,96.9032],[55.0642,96.8862],[55.0002,96.8802],[54.8202,96.8632],[54.5762,96.8382],[54.5082,96.8312],[54.3322,96.8122],[54.0162,96.7762],[53.7702,96.7462],[53.6012,96.7242],[53.2792,96.6822],[25.2242,92.7782],[25.1892,92.7732],[25.1392,92.7652],[25.0822,92.7542],[25.0502,92.7472],[24.9932,92.7332],[24.9812,92.7302],[24.9442,92.7202],[24.9332,92.7172],[24.8772,92.7002],[24.8252,92.6832],[24.8132,92.6792],[24.7582,92.6592],[24.7082,92.6392],[24.6502,92.6142],[24.5942,92.5882],[24.5522,92.5672],[24.5012,92.5402],[24.4832,92.5302],[24.4412,92.5062],[24.3892,92.4752],[24.3752,92.4662],[24.3402,92.4432],[24.3312,92.4372],[24.2832,92.4042],[24.2442,92.3752],[24.2362,92.3692],[24.1902,92.3332],[24.1522,92.3022],[24.1452,92.2962],[24.1012,92.2582],[24.0582,92.2182],[24.0372,92.1982],[23.9892,92.1502],[23.9542,92.1132],[23.9352,92.0922],[23.9152,92.0692],[23.8772,92.0242],[23.8412,91.9782],[23.8272,91.9602],[23.8062,91.9322],[23.8032,91.9282],[23.7692,91.8802],[23.7542,91.8582],[23.7392,91.8362],[23.7052,91.7822],[23.6752,91.7312],[23.6472,91.6802],[23.6272,91.6422],[23.6152,91.6182],[23.5922,91.5702],[23.5662,91.5122],[23.5452,91.4612],[23.5242,91.4072],[23.5052,91.3512],[23.5042,91.3482],[23.4872,91.2962],[23.4712,91.2402],[23.4562,91.1832],[23.4422,91.1222],[23.4312,91.0652],[23.4222,91.0122],[23.4212,91.0062],[23.4132,90.9542],[23.4082,90.9112],[23.4052,90.8832],[23.3992,90.8032],[23.3972,90.7662],[23.3962,90.7372],[23.3962,72.3742]]]
        mesh_min, mesh_max = self.adaptive_bed_mesh.generate_mesh_with_exclude_object(objects)

        self.assertTupleEqual(mesh_min, (23.3962, 66.0562))
        self.assertTupleEqual(mesh_max, (83.3972, 97.0602))

    def test_generate_bed_mesh_param_with_gcode_analysis(self):
        # Generate file list
        gcode_with_bed_mesh_min_max = {
            '2x_3d_benchy.gcode': ((23.15, 17.76), (86.3, 94.02)),
            '2x_3d_benchy_arc_fitting.gcode': ((23.15, 17.76), (86.3, 94.02)),
            '3d_benchy_arc_fitting.gcode': ((29.78, 47.53), (77.49, 72.47)),
            '3DBenchy-Voron 0.1-ABS.gcode': ((52.16, 38.46), (67.84, 76.92)),
            'G2_Cylinder_PLA_12s.gcode': ((49.63, 49.3), (91.46, 75.58)),
            'Rear Right Foot_one_piece_ABS_5h54m.gcode': ((36.11, 35.66), (81.8, 81.34)),
            'speed_benchy_how_dare_you.gcode': ((108.14, 117.23), (146.57, 132.77))
        }

        for gcode_filename, (ref_mesh_min, ref_mesh_max) in gcode_with_bed_mesh_min_max.items():
            with self.subTest(gcode_filename):
                gcode_filepath = os.path.join(test_data_dir, gcode_filename)
                mesh_min, mesh_max = self.adaptive_bed_mesh.generate_mesh_with_gcode_analysis(gcode_filepath)
                mesh_min, mesh_max = self.adaptive_bed_mesh.apply_min_max_limit(mesh_min, mesh_max)

                self.assertTupleEqual(mesh_min, ref_mesh_min)
                self.assertTupleEqual(mesh_max, ref_mesh_max)

    def test_debug_gcode_analysis_plot(self):
        from matplotlib import pyplot as plt
        gcode_file = os.path.join(test_data_dir, 'speed_benchy_how_dare_you.gcode')

        first_layer_move_vertices = self.adaptive_bed_mesh.extract_first_layer_from_gcode_file(gcode_file)

        fig = plt.figure()
        ax = fig.subplots()

        # Plot XY move on the first layer
        x_moves = []
        y_moves = []
        for move in first_layer_move_vertices:
            x_moves.append(move['X'])
            y_moves.append(move['Y'])

        ax.plot(x_moves, y_moves, label='Toolhead Move')

        # Plot print boundary
        (x_min, y_min), (x_max, y_max) = self.adaptive_bed_mesh.get_move_min_max(first_layer_move_vertices)
        ax.plot([x_min, x_min, x_max, x_max, x_min], [y_min, y_max, y_max, y_min, y_min], label='Print Boundary')

        # Plot probe points
        mesh_min, mesh_max = self.adaptive_bed_mesh.apply_min_max_margin((x_min, y_min), (x_max, y_max))
        mesh_min, mesh_max = self.adaptive_bed_mesh.apply_min_max_limit(mesh_min, mesh_max)
        print(f'Mesh Min: {mesh_min}, Mesh Max: {mesh_max}')

        (num_horizontal_probes, num_vertical_probes), probe_points, zero_reference_position = self.adaptive_bed_mesh.get_probe_points(mesh_min, mesh_max)
        print(num_horizontal_probes, num_vertical_probes)

        probe_points_x, probe_points_y = zip(*probe_points)
        ax.plot(probe_points_x, probe_points_y, marker='x', linestyle='--', label='Probe points')

        ax.scatter(zero_reference_position[0], zero_reference_position[1], marker='o', label='Zero Reference Point')

        # Set equal scale
        ax.set_aspect('equal', adjustable='box')
        ax.legend(*ax.get_legend_handles_labels())
        plt.show()


if __name__ == '__main__':
    unittest.main()